{% extends "base.html" %}

{% block title %}Dashboard - Kenya-Agro{% endblock %}

{% block head %}
<!-- Additional dashboard-specific styles -->
<style>
    .metric-card {
        border-left: 4px solid var(--agricultural-green);
        transition: transform 0.2s ease;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .insight-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        transition: border-color 0.3s ease;
    }
    .insight-card:hover {
        border-color: var(--agricultural-green);
    }
    .live-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        margin-right: 6px;
        box-shadow: 0 0 0 0 rgba(40,167,69,0.7);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40,167,69,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40,167,69,0); }
        100% { box-shadow: 0 0 0 0 rgba(40,167,69,0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 text-agricultural-green mb-2">
                        <i class="fas fa-tractor me-2"></i>Welcome back, {{ data.farmer_profile.name.split()[0] if data.farmer_profile else 'Farmer' }}!
                    </h1>
                    <p class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>{{ data.farmer_profile.county if data.farmer_profile else 'Kenya' }} County
                        {% if data.farmer_profile and data.farmer_profile.farm_size %}
                            • {{ data.farmer_profile.farm_size }} acres
                        {% endif %}
                        {% if data.farmer_profile and data.farmer_profile.experience %}
                            • {{ data.farmer_profile.experience }} years experience
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card metric-card h-100 border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-seedling fa-2x text-agricultural-green"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title text-muted mb-0">Primary Crops</h6>
                            <h4 class="fw-bold mb-0">
                                {{ data.farmer_profile.crops|length if data.farmer_profile and data.farmer_profile.crops else 0 }}
                            </h4>
                            <small class="text-success">
                                {% if data.farmer_profile and data.farmer_profile.crops %}
                                    {{ data.farmer_profile.crops[:2]|join(', ') }}{% if data.farmer_profile.crops|length > 2 %}...{% endif %}
                                {% else %}
                                    No crops selected
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card metric-card h-100 border-0 ">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-chart-line fa-2x text-agricultural-green"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title text-muted mb-0">County Data Points</h6>
                            <h4 class="fw-bold mb-0">{{ data.county_data|length if data.county_data else 0 }}</h4>
                            <small class="text-info">
                                <i class="fas fa-database me-1"></i>Available records
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card metric-card h-100 border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-lightbulb fa-2x text-agricultural-green"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title text-muted mb-0">Recommendations</h6>
                            <h4 class="fw-bold mb-0">{{ data.crop_recommendations|length if data.crop_recommendations else 0 }}</h4>
                            <small class="text-warning">
                                <i class="fas fa-star me-1"></i>AI Generated
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card metric-card h-100 border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-money-bill-wave fa-2x text-agricultural-green"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="card-title  mb-0">Market Updates</h6>
                            <h4 class="fw-bold mb-0">
                                <span id="market-updates-count">
                                {% if data.market_trends and data.market_trends.price_trends %}
                                    {{ data.market_trends.price_trends|length }}
                                {% else %}
                                    0
                                {% endif %}
                                </span>
                            </h4>
                            <small class="text-primary">
                                <span class="live-dot"></span><i class="fas fa-trending-up me-1"></i>Live prices
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Crop Production Chart -->
        <div class="col-xl-8">
            <div class="card border-0 ">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2 text-agricultural-green"></i>
                        Agricultural Production Trends - {{ data.farmer_profile.county if data.farmer_profile else 'Kenya' }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if data.county_data %}
                        <div class="chart-container">
                            <canvas id="productionChart"></canvas>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-bar fa-4x  mb-3"></i>
                            <h5 class=>No Production Data Available</h5>
                            <p class="mb-3">
                                We're currently fetching agricultural data for {{ data.farmer_profile.county if data.farmer_profile else 'your' }} county.
                                This may take a few moments.
                            </p>
                            <button class="btn btn-agricultural-green" onclick="updateData()">
                                <i class="fas fa-refresh me-2"></i>Fetch Data
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Crop Recommendations -->
        <div class="col-xl-4">
            <div class="card border-0 ">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2 text-agricultural-green"></i>
                        Crop Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    {% if data.crop_recommendations %}
                        {% for recommendation in data.crop_recommendations %}
                            <div class="insight-card p-3 mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-seedling text-agricultural-green fa-lg mt-1"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="fw-bold mb-1">{{ recommendation.crop }}</h6>
                                        <p class=" small mb-2">{{ recommendation.reason }}</p>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-success-subtle text-success small">
                                                {{ recommendation.potential_yield }} Potential
                                            </span>
                                            {% if recommendation.avg_value %}
                                                <span class=" small ms-2">
                                                    Avg: {{ recommendation.avg_value }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Market Trends and Weather -->
    <div class="row g-4 mt-2">
        <!-- Market Price Trends -->
        <div class="col-lg-6">
            <div class="card border-0">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-bill-trend-up me-2 text-agricultural-green"></i>
                        Market Price Trends
                    </h5>
                    <small id="market-updated-at" class="text-muted"></small>
                </div>
                <div class="card-body">
                    <div id="market-live-container">
                        {% if data.market_trends and data.market_trends.price_trends %}
                            {% for crop, price_info in data.market_trends.price_trends.items() %}
                                <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-seedling text-agricultural-green me-2"></i>
                                        <span class="fw-bold">{{ crop }}</span>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">KES {{ price_info.current_price }}/kg</div>
                                        <small class="">{{ price_info.trend }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4" id="market-empty">
                                <i class="fas fa-chart-line fa-3x  mb-3"></i>
                                <h6 class=>Market Data Loading</h6>
                                <p class=>
                                    Current market prices will be displayed here once available.
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather and Climate -->
        <div class="col-lg-6">
            <div class="card border-0 ">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cloud-sun me-2 text-agricultural-green"></i>
                        Weather Insights
                    </h5>
                    <small id="weather-updated-at" class="text-muted"></small>
                </div>
                <div class="card-body">
                    <div id="weather-live-container">
                        {% if data.weather_insights %}
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-thermometer-half text-warning fa-2x mb-2"></i>
                                        <div class="fw-bold"><span id="weather-temp">{{ data.weather_insights.temperature or 'N/A' }}</span>°C</div>
                                        <small class=>Temperature</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-tint text-info fa-2x mb-2"></i>
                                        <div class="fw-bold"><span id="weather-rain">{{ data.weather_insights.rainfall or 'N/A' }}</span>mm</div>
                                        <small class=>Rainfall</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <small id="weather-forecast" class="text-muted"></small>
                            </div>
                        {% else %}
                            <div class="text-center py-4" id="weather-empty">
                                <i class="fas fa-cloud fa-3x mb-3"></i>
                                <h6 class=>Weather Data Loading</h6>
                                <p class= "small">
                                    Climate insights for your area will be displayed here.
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card border-0 ">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2 text-agricultural-green"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-agricultural-green w-100">
                                <i class="fas fa-file-alt me-2"></i>Generate Report
                            </a>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-agricultural-green w-100" onclick="document.getElementById('chat-toggle').click()">
                                <i class="fas fa-robot me-2"></i>Ask AI Assistant
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-agricultural-green w-100" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export Data
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-agricultural-green w-100" onclick="refreshLiveNow()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Live Data
                            </button>
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">Live sections auto-refresh every 30s.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-agricultural-green mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h6 class="mb-0">Updating agricultural data...</h6>
                <small class="text-muted">This may take a few moments</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
// === Live Data Config ===
const farmerCounty = JSON.parse('{{ (data.farmer_profile.county | tojson) if data.farmer_profile else "\"null\"" }}');
const farmerCrops = JSON.parse('{{ (data.farmer_profile.crops | tojson) if data.farmer_profile else "[]" }}');
const LIVE_REFRESH_MS = 30000;

// Initialize dashboard with data
document.addEventListener('DOMContentLoaded', function() {
    // Production chart data from backend
    const countyData = JSON.parse('{{ data.county_data | tojson | safe if data.county_data else "[]" }}');
    if (countyData && countyData.length > 0) {
        initializeProductionChart(countyData);
    }

    // Tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initial live fetch
    fetchLiveWeather();
    fetchLiveMarketPrices();

    // Polling
    setInterval(() => {
        fetchLiveWeather();
        fetchLiveMarketPrices();
    }, LIVE_REFRESH_MS);
});

// ---- Live Weather ----
async function fetchLiveWeather() {
    if (!farmerCounty) return;
    try {
        const res = await fetch(`/api/live/weather?county=${encodeURIComponent(farmerCounty)}`);
        if (!res.ok) throw new Error('Weather request failed');
        const payload = await res.json();
        if (!payload || payload.success === false) throw new Error(payload?.message || 'Weather error');

        // Update DOM
        const temp = document.getElementById('weather-temp');
        const rain = document.getElementById('weather-rain');
        const forecast = document.getElementById('weather-forecast');
        const updatedAt = document.getElementById('weather-updated-at');

        if (temp) temp.textContent = (payload.temperature_c ?? 'N/A');
        if (rain) rain.textContent = (payload.rainfall_mm ?? 'N/A');
        if (forecast) forecast.textContent = payload.forecast ? `Forecast: ${payload.forecast}` : '';
        if (updatedAt) updatedAt.textContent = payload.updated_at ? `Updated ${new Date(payload.updated_at).toLocaleTimeString()}` : '';

        // If empty layout present, replace with cards
        const empty = document.getElementById('weather-empty');
        if (empty) {
            const container = document.getElementById('weather-live-container');
            container.innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-thermometer-half text-warning fa-2x mb-2"></i>
                            <div class="fw-bold"><span id="weather-temp">${payload.temperature_c ?? 'N/A'}</span>°C</div>
                            <small>Temperature</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-tint text-info fa-2x mb-2"></i>
                            <div class="fw-bold"><span id="weather-rain">${payload.rainfall_mm ?? 'N/A'}</span>mm</div>
                            <small>Rainfall</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <small id="weather-forecast" class="text-muted">${payload.forecast ? 'Forecast: ' + payload.forecast : ''}</small>
                </div>
            `;
        }
    } catch (err) {
        console.error('Live weather error:', err);
    }
}

// ---- Live Market Prices ----
async function fetchLiveMarketPrices() {
    if (!farmerCounty) return;
    const crops = Array.isArray(farmerCrops) && farmerCrops.length ? farmerCrops : [];
    const cropsParam = crops.length ? `&crops=${encodeURIComponent(crops.join(','))}` : '';
    try {
        const res = await fetch(`/api/live/prices?county=${encodeURIComponent(farmerCounty)}${cropsParam}`);
        if (!res.ok) throw new Error('Prices request failed');
        const payload = await res.json();
        if (!payload || payload.success === false) throw new Error(payload?.message || 'Prices error');

        const list = Array.isArray(payload.prices) ? payload.prices : [];
        const container = document.getElementById('market-live-container');
        const updatedEl = document.getElementById('market-updated-at');
        const countEl = document.getElementById('market-updates-count');

        if (updatedEl && payload.updated_at) {
            updatedEl.textContent = `Updated ${new Date(payload.updated_at).toLocaleTimeString()}`;
        }

        if (countEl) countEl.textContent = list.length || 0;

        if (!container) return;

        if (!list.length) {
            container.innerHTML = `
                <div class="text-center py-4" id="market-empty">
                    <i class="fas fa-chart-line fa-3x  mb-3"></i>
                    <h6>Market Data Unavailable</h6>
                    <p class="small">Please try again later.</p>
                </div>`;
            return;
        }

        container.innerHTML = list.slice(0, 8).map(item => `
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                <div class="d-flex align-items-center">
                    <i class="fas fa-seedling text-agricultural-green me-2"></i>
                    <span class="fw-bold">${escapeHtml(item.crop)}</span>
                </div>
                <div class="text-end">
                    <div class="fw-bold">KES ${Number(item.price_kes_per_kg).toLocaleString()}/kg</div>
                    <small class="text-muted">${item.source ? escapeHtml(item.source) : 'Live'}</small>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Live prices error:', err);
    }
}

function escapeHtml(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/[&<>"']/g, function(m) {
        return ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        })[m];
    });
}

// ---- Existing Chart + Utilities ----
function initializeProductionChart(data) {
    const ctx = document.getElementById('productionChart').getContext('2d');
    
    // Group data by crop and year
    const cropData = {};
    data.forEach(item => {
        if (!cropData[item.crop]) {
            cropData[item.crop] = {};
        }
        cropData[item.crop][item.year] = item.value;
    });
    
    // Get unique years and sort
    const years = [...new Set(data.map(item => item.year))].sort();
    
    // Create datasets for each crop
    const datasets = Object.keys(cropData).slice(0, 5).map((crop, index) => {
        const colors = [
            'rgba(76, 175, 80, 0.8)',   // Green
            'rgba(255, 193, 7, 0.8)',   // Amber
            'rgba(33, 150, 243, 0.8)',  // Blue
            'rgba(255, 87, 34, 0.8)',   // Orange
            'rgba(156, 39, 176, 0.8)'   // Purple
        ];
        
        return {
            label: crop,
            data: years.map(year => cropData[crop][year] || 0),
            backgroundColor: colors[index % colors.length],
            borderColor: colors[index % colors.length].replace('0.8', '1'),
            borderWidth: 2,
            fill: false,
            tension: 0.1
        };
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: years.map(year => year.toString()),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Production (Tonnes)' }
                },
                x: {
                    title: { display: true, text: 'Year' }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}

function updateData() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    // Make request to update data endpoint
    fetch('/api/update-data')
        .then(response => response.json())
        .then(data => {
            modal.hide();
            if (data.success) {
                // Show success message
                showAlert('success', 'Data updated successfully! Refreshing page...');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert('danger', 'Failed to update data: ' + data.message);
            }
        })
        .catch(error => {
            modal.hide();
            console.error('Error updating data:', error);
            showAlert('danger', 'Error updating data. Please try again.');
        });
}

function refreshLiveNow() {
    fetchLiveWeather();
    fetchLiveMarketPrices();
    showAlert('success', 'Live data refreshed');
}

function exportData() {
    // Simple data export functionality
    const data = {
        farmer_profile: JSON.parse('{{ data.farmer_profile | tojson | safe if data.farmer_profile else "{}" }}'),
        county_data: JSON.parse('{{ data.county_data | tojson | safe if data.county_data else "[]" }}'),
        recommendations: JSON.parse('{{ data.crop_recommendations | tojson | safe if data.crop_recommendations else "[]" }}')
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'kenya-agor-dashboard-data.json';
    link.click();
    
    URL.revokeObjectURL(url);
    showAlert('success', 'Dashboard data exported successfully!');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '100px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
